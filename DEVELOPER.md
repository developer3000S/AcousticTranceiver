# Техническое описание проекта: Акустический текстовый трансивер

## 1. Обзор и стек технологий

Этот документ предоставляет техническое описание проекта. Приложение предназначено для передачи текстовых данных с использованием звуковых сигналов (DTMF) через аналоговый аудиоканал, такой как телефонный звонок.

**Основной стек технологий:**

*   **Фреймворк:** React 18
*   **Язык:** TypeScript
*   **Сборщик:** Vite
*   **Стилизация:** Tailwind CSS
*   **Аудио:** Web Audio API
*   **Тестирование:** Vitest, JSDOM
*   **Сборка для мобильных устройств:** Capacitor

---
## 2. Архитектура и структура проекта

```
src/
├── App.tsx                     # Главный компонент приложения
├── components/
│   ├── Sender.tsx              # UI и логика для отправки сообщений
│   ├── Receiver.tsx            # UI и логика для приема сообщений
│   └── ...                     # Другие UI-компоненты
├── hooks/
│   └── useAudioProcessor.ts    # Хук для обработки аудиопотока и декодирования
├── services/
│   ├── audioService.ts         # Генерация и воспроизведение аудио, создание WAV
│   └── ...                     # Другие сервисы
├── constants.ts                # Глобальные константы, протоколы
└── index.tsx                   # Точка входа в приложение
```

---
## 3. Ключевые концепции

### 3.1. Протокол передачи данных

Передача данных основана на технологии **DTMF (Dual-Tone Multi-Frequency)**. Этот подход обеспечивает высокую устойчивость к помехам.

**Структура пакета:**

1.  **Кодирование:** Текст (строчные буквы, цифры, знаки препинания) преобразуется в последовательность двухзначных цифровых кодов (например, `а` -> `00`).
2.  **Обрамление:** Полученная строка цифр обрамляется маркерами: `*` в начале и `#` в конце.
3.  **Передача:** Вся последовательность, включая маркеры, передается с помощью стандартных DTMF-тонов. Контрольная сумма не используется, так как DTMF сам по себе очень надежен.

### 3.2. Режимы передачи (Протоколы)

В `constants.ts` определены несколько режимов, основанных на DTMF. Они не меняют сам метод, а лишь его параметры (`toneDuration`, `pauseDuration`) для достижения разных целей:

*   **`dtmf_standard`:** Сбалансированные настройки.
*   **`dtmf_fast` / `dtmf_ultra_fast`:** Уменьшенные задержки для быстрой передачи.
*   **`dtmf_reliable`:** Увеличивает длительность тонов и **дублирует каждую цифру** в закодированном сообщении для максимальной помехоустойчивости.
*   **`dtmf_quiet` / `dtmf_ultra_quiet`:** Используют очень длинные тоны и паузы, что помогает сигналу "пробиться" через сильные шумы.
*   **`custom`:** Режим, который активируется при ручной настройке параметров через UI.

---
## 4. Глубокое погружение в компоненты и сервисы

### 4.1. `audioService.ts` (Сервис аудио)

Отвечает за всю логику, связанную с генерацией звука.

*   `playMessage`: Асинхронно воспроизводит сообщение. Использует `AudioContext` для создания и управления `OscillatorNode` для каждой из двух частот в DTMF-сигнале.
*   `generateMessageWav`: Использует `OfflineAudioContext` для рендеринга аудиосигнала в `AudioBuffer` без его воспроизведения, что позволяет быстро сгенерировать `.wav` файл.

### 4.2. `useAudioProcessor.ts` (Хук обработки аудио)

Это ядро логики получателя. Он был значительно упрощен и теперь работает только с DTMF.

*   **Анализ сигнала:** В цикле `requestAnimationFrame` (`analysisLoop`) постоянно анализируется частотный спектр. Хук ищет два одновременных пика в низкочастотном и высокочастотном диапазонах, характерных для DTMF.
*   **Автоматическая регулировка усиления (АРУ / AGC):** Хук динамически вычисляет уровень окружающего шума и подстраивает порог обнаружения сигнала. Это позволяет надежно принимать сигналы разной громкости.
*   **Протокольная стейт-машина:**
    *   Хук отслеживает состояние приема: `IDLE` или `DTMF_TEXT`.
    *   Когда обнаруживается маркер `*`, стейт-машина переходит в режим приема, и все последующие распознанные цифры добавляются в буфер.
    *   Когда обнаруживается маркер `#`, прием завершается. Содержимое буфера (строка цифр) декодируется обратно в текст.

### 4.3. `Sender.tsx`

Компонент-отправитель.

*   Управляет состоянием вводимого сообщения, выбранного шаблона и настроек передачи (режим, громкость, длительность тона, пауза).
*   Визуализирует неподдерживаемые символы, используя `TEXT_ENCODING_MAP`.
*   Позволяет пользователю выбирать предустановленные режимы или настраивать параметры вручную с помощью слайдеров.

### 4.4. `Receiver.tsx`

Компонент-получатель.

*   Использует хук `useAudioProcessor` для управления состоянием прослушивания и получения декодированных данных.
*   Отображает список принятых сообщений и визуализатор спектра.

---
## 5. Тестирование

Проект использует **Vitest** для unit-тестирования. Тесты находятся рядом с тестируемыми модулями. Поскольку Web Audio API недоступна в `jsdom`, создан файл `src/setupTests.ts`, который мокирует `AudioContext` и `OfflineAudioContext`.
